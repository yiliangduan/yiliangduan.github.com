<!DOCTYPE html>













<html class="theme-next mist" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=7.1.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","display":"remove","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="一点心得">
<meta property="og:url" content="http://yiliangduan.github.com/index.html">
<meta property="og:site_name" content="一点心得">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一点心得">





  
  
  <link rel="canonical" href="http://yiliangduan.github.com/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>一点心得</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        
        <span class="site-title">一点心得</span>
        
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br/>关于</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yiliangduan.github.com/2019/11/04/graphics/pbr_learning/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yiliangduan@gmail.com"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一点心得"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/11/04/graphics/pbr_learning/" class="post-title-link" itemprop="url">我所理解的PBR</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-11-04 16:44:10" itemprop="dateCreated datePublished" datetime="2019-11-04T16:44:10+08:00">2019-11-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-11-18 11:04:26" itemprop="dateModified" datetime="2019-11-18T11:04:26+08:00">2019-11-18</time>
              
            
          </span>

          

          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>个人的理解，可能有错误的地方。</p>
</blockquote>
<font face="微软雅黑 light" size="5">什么是PBR</font>

<hr>
<p>PBR（Physically Based Rendering）是一种基于物理方式旨在更加准确的模拟真实世界光照的图形渲染方法。简单点说，PBR就是计算光照射到表面时该表面射出（反射或折射）光的一套计算方法，基于物理方式在于它在计算射出光强度的时候更加注重和射入光的能量守恒。因为能量守恒，当一束光照射到某个表面时射出的光线强度会更加接近于真实世界，那么得到的光照效果就更加逼真了。这样做带来的另外一个好处在于可以提供更加直观的效果配置参数给美术人员。现在来看看PBR这套计算方法，我们称这个计算方法为反射方程（The Reflectance Equation）：</p>
<p>$$<br>L_0(p, w) = L<em>e(p, w) + \int</em>{Ω} f_r(p, w_i, w_0)\  L_i(p, w)\ cos\theta_i \  dw_i<br>$$<br>公式里的每个符号的含义：</p>
<ul>
<li>$$p$$ ：场景中一个表面上的点</li>
<li>$$w_0$$ ：出射光方向</li>
<li>$$w_i$$ ：入射光方向</li>
<li>$$L_0(p, w)$$ ：点 $$p$$ 处的总共发射的辐射</li>
<li>$$L_e(p, w)$$ ：点 $$p$$ 处的预置发射的辐射</li>
<li>$$ \Omega $$ ：以点 $$p$$的法线为中心的单位半球</li>
<li>$$\int_{Ω} dw_i$$ ：入射光在整个单位半球的积分</li>
<li><p>$$f_{r}(p, w_i, w_0)$$ ：双向反射分布函数（Bidrectional Reflectance Distribution Function简写BRDF）</p>
</li>
<li><p>$$L_i(p, w)$$：$$p$$ 点所接受的辐射</p>
</li>
<li>$$cos\theta_i$$：入射光照 向量和 $$p$$ 点的法线向量的点积（dot product），用作辐照度由于射入角度产生的衰减因子</li>
</ul>
<p>根据这两个概念可以拆分我们的反射方程为两个部分辐射和BRDF。简单来说其实我们物体表面的反射光亮度 = 辐照度 * BRDF。接下来详细介绍下这两部分内容，在理解这些内容之后就理解反射方程了。</p>
<font face="微软雅黑 light" size="5">辐射</font>

<hr>
<p>真实世界中我们是怎样看到眼前的物体的呢？所有的这些物体都是因为有光照射到物体上，光在物体上经过反射（镜面反射，漫反射）进入到我们眼睛，在我们的眼睛成像于是看到了这些物体。但是光源照射到表面之后根据该表面的不同属性反射或者折射出的光的强度会不一样，比如一个表面光滑的金属铁球和一个表面带毛的网球，两个球放在同样的太阳底下你会看到金属铁球表面明显更亮，由此可以看出物体表面的光强不仅和光源有关系，还和物体本身的材质有关系。</p>
<p>那么我们首先来了解光的强度对物体表面材质的影响。需要测量对材质表面反射光的强度（或者称为辐射强度），首先我们得明白光具体含义，<a href="https://zh.wikipedia.org/wiki/%E5%85%89" target="_blank" rel="external">wikipedia</a>上是这样介绍的：光通常指的是人类眼睛可以见的<em>电磁波（可见光）</em>。既然光是电磁波，那么我们就需要用电磁波的测量单位<font color="#6495ED">辐射能</font>来测量光。</p>
<font face="微软雅黑 light" size="4">辐射通量（ Radiant flux ）</font>

<p>辐射通量定义为每单位时间发射，反射，传输或接收的辐射能总和。用公式表示为：<br>$$<br>\Phi = \frac {dQ}{dt}<br>$$<br>单位为 焦耳/秒（J/s），或者更常用的瓦特（w）。</p>
<p>举个例子，光源在一个小时内发出了$$Q = 200,000J$$的辐射能，假如这个光源在每个小时内都是发出同样的能量，我们可以计算出这个光源的辐射通量：<br>$$<br>\Phi = 200,000J / 3600s \approx 55.6W<br>$$</p>
<font face="微软雅黑 light" size="4">辐照度（Irradiance ）和辐射出射度（Radiant Existance）</font>

<p>在辐射通量的基础上如果再给定辐射的面积$$A$$，我们可以定义这个面积内的平均辐射能量的密度，用公式表示为：<br>$$<br>E = \frac{ \Phi}{A}<br>$$<br>单位为$$W/m^2$$。</p>
<p>如果是面积$$A$$接受到的辐射能量密度，我们称$$E$$为辐照度。如果是面积$$A$$发出的辐射能量密度，我们称$$E$$为辐射出射度。从公式我们可以看出，同样的辐射通量，辐射到的面积越大则辐照度越小。举个例子，如果一个点光源在所有的辐射方向上的辐射量是均匀的，如图[1]：</p>
<p><img src="/images/pbr_learning/pbr_spot_light_irradiance.png" alt=""></p>
<p><center>图[1]. 点光源均匀的辐射到四周，测量这个点光源的辐辐照度按照球的体积所接受的辐射通量来确定。</center><br>那么这个点光源的辐照度为：<br>$$<br>E = \frac {\Phi}{4\pi r^2}<br>$$</p>
<font face="微软雅黑 light" size="4">辐射强度（Radiant Intensity）</font>

<p>辐射强度表示一个立体角内所受到的辐射通量的总和。如图[2]，$$A$$是单位球面的一个立体角， 立体角（Solid Angle）表示的是单位球面的一个截面和球心所围成的立体的体积。$$w$$表示的是辐射入射方向。从图中看辐射射入的方向和表面$$A$$是有夹角的，这会导致在表面上真正接受到的辐射面积会变小，此时辐照度可以用以下公式表示：<br>$$<br>E = \frac{\Phi }{Acos\theta}<br>$$<br>与辐照度和辐射出射度不同之处在于，辐射强度考虑的是受辐射的表面面积，而前者是辐射所扩散的范围，也就是体积。所以如果对于一个单位球来说的话，它的辐射强度可以表示为：<br>$$<br>I = \frac{ \Phi} {4 \pi}<br>$$<br>其中$$I$$ 表示辐射强度，单位是$$W/sr$$。另外$$4 \pi$$表示的是球体的表面积，我们可以看做是球面上有分布均匀的无数个入射光照射到平面的点$$p$$处的辐射总和，称之为$$p$$出的辐射强度。如果是考虑有限的入射光，比如立体角所限定的范围内，那么辐射强度可以表示为以下形式：<br>$$<br>I = \lim_ {\Delta w -&gt; 0} \frac{\Delta \Phi}{\Delta w} = \frac{d \Phi}{dw}<br>$$<br>将辐射通量和入射光照的函数做微分处理，得到辐射强度的通用表达式。这里解释下上面的微分操作，函数里面的辐射通量取入射光的在接近于0（但是不等于0，就是一个极值）时的增量，两者再做商，得出的就是辐射密度。</p>
<p><img src="/images/pbr_learning/pbr_soild_angle_radiance.png" alt=""></p>
<p><center>图[2] 立体角范围内接受光照</center></p>
<font face="微软雅黑 light" size="4">辐射率（Radiance）</font>

<p>辐射率表示的是光源在单位面积内，单位立体角上的辐射强度。如图[2]，单位面积$$A$$，从单位立体角$$w$$接收到的光源的辐射强度就是该面积所收到的辐射率。用公式表示为：<br>$$<br>L(p, w) = \lim_{\Delta w-&gt;0} \frac{\Delta E_w(p)}{\Delta w} = \frac{dE<em>w(p)}{dw}<br>$$<br>结合公式（8）我们可以得到在$$p$$点的辐射强度另外一种表达形式：<br>$$<br>E(p, w) = \int</em>\Omega L_i(p, w) \ cos\theta\ dw<br>$$</p>
<p>这个辐射强度的表达式是直接应用到PBR的反射方程计算公式中的，在反射方程实际计算的时候$$L_i(p, w)$$我们直接使用RGB值，这个RGB可以是采样一张贴图，也可以是着色器预置一个专门的变量让用户来自定义这个值。$$cos\theta$$是光照入射向量和平面的法线方向，光线由于角度入射在平面上的面积肯定变小了，而总的辐射变小了，这里的余弦值可以看做是光线的衰减值。对于入射光照$$w$$的积分，在游戏中我们可以假设入射光就是一条直线光，所以真正计算的时候可以不用做积分运算。</p>
<font face="微软雅黑 light" size="5">双向反射分布函数（BRDF）</font>

<hr>
<p>BRDF定义光在不透明表面是怎样反射的。如下图[3]，$$w_i$$是入射光方向，$$w_r$$是出射光方向（也是相机观察方向），$$n$$是法线。BRDF计算从表面沿着$$w_r$$方向发射的辐射出射度与光源沿着$$w_i$$方向入射到表面的辐照度的比值。</p>
<p><img src="/images/pbr_learning/300px-BRDF_Diagram.svg.png" alt=""></p>
<p><center>图[4]</center><br>用公式表示为：<br>$$<br>f_r(w_i, w_r) = \frac{dL_r(w_r)}{dE_i(w_i)} = \frac{dL_r(w_r)}{L_i(w_i)cos\theta _i dw_i}<br>$$<br>转换下为:<br>$$<br>dL_r(w_r) = f_r(w_i, w_r)L_i(w_i)cos\theta _idw_i<br>$$<br>进行下积分:<br>$$<br>L_r(w<em>r) = \int</em>\Omega f_r(w_i, w_r)L_i(w_i)cos\theta_idw_i<br>$$<br>得到的$$L_r(w_r)$$是$$w_r$$方向的辐射出射度，方程（7）称为反射方程（ The Reflectance Equation）或者PBR的渲染方程（The Rendering Equation）。方程关于辐射的部分在文章的上半部分已经介绍了，现在来介绍下BRDF的$$f_r(w_i, w_r)$$是怎样计算的。</p>
<font face="微软雅黑 light" size="4">BRDF计算模型</font>

<p>BRDF将材质表面的光照反应分为两部分：</p>
<ul>
<li>漫反射（diffuse）：材质表面反射或者折射出去的比较杂乱的这部分光照。</li>
<li>高光（specular）：材质表面以法线为中心的与入射光照对称角度反射出去的光照。</li>
</ul>
<p>也就是说在BRDF的定义模型下，物体表面接受到光照之后会分两部分 可以用表达式表示为：<br>$$<br>f_r(w_i, w<em>r) = f</em>{diffuse}(w_i, w<em>l) + f</em>{specular}(w_i, w_l)<br>$$<br>如下图[5]所示:</p>
<p><img src="/images/pbr_learning/BRDF_Cal_Model.png" alt=""></p>
<p><center>图[5]. 入射光照在经过表面反射或者折射之后归为两种模型：漫反射（Diffuse）和高光（Specular）。</center><br>考虑到光传播的能量守恒，在光照射到材质表面的时候会由于材质的粗糙度的原因一定程度上会减弱反射出去的高光的强度，如图[6]：</p>
<p><img src="/images/pbr_learning/diagram_single_vs_multi_scatter.png" alt=""></p>
<p><center>图[6]. 入射光照如果只考虑一次反射的话，那么像左图的情况，光照就不会反射出任何光，相当于损失了。如果考虑二次反射的话是可以反射出去并且进入到视野的,如图右。</center><br>如果粗糙度比较严重的话，光照在材质表面需要经过很多次反射才能反射出去，甚至最终反射出去的光的出射角度并不能进入到视野中去。这部分光只能算作是光衰减的部分。基于此我们对计算BRDF的公式做出下面这样的改变：<br>$$<br>f_r(w_i, w_r) = k<em>df</em>{diffuse}(w_i, w_r) + k<em>sf</em>{specular}(w_r, w_r)<br>$$<br>其中$$k_d$$和$$k_s$$满足：<br>$$<br>k_d + k_s \leq  1<br>$$<br>介绍了BRDF的计算模型之后，接下来介绍下组成BRDF模型的漫反射和高光的具体计算方式。</p>
<font face="微软雅黑 light" size="4">BRDF的漫反射（Diffuse）</font>

<p>漫反射其实包括两部分，一部分是由于材质表面粗糙的原因光照经过多次反射最终反射出表面，但是出射的角度比较杂乱，如图[6]所描述的。另一部分则是材质的特殊性导致折射在材质的次表面（subsurface）的光线又折射出表面形成的关照。如图[7]：</p>
<p><img src="/images/pbr_learning/BRDF_Diffuse.png" alt=""></p>
<p><center>图[7]. 部分折射的光照会最终折射出表面进入视野中。</center><br>但是不是所有的材质都会有这种现象，这个就是导体与电介质两种材质的区别了。纯金属材质（导体）没有在次表面发生散射的情况。这也是现实生活中导体材质的表面看起来光照更加强分布比较集中规则，而电介质材质的表面光照相对较弱的原因。</p>
<p>在游戏引擎中对漫反射光照的处理一般采用的是$$lambert$$计算模型。$$lambert$$模型的用如下公式表示：<br>$$<br>f_{lambert} = \frac{\sigma}{\pi}<br>$$<br>$$ \sigma $$为漫反射率，除以$$\pi$$的得到半球的漫反射因子。代码中计算漫反射时把漫反射颜色乘以漫反射因子，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">float</span>  <span class="title">brdf_fd_lambert</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _ReflectanceRatio / UNITY_PI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 diffuse = diffuseColor * brdf_fd_lambert();</span><br></pre></td></tr></table></figure>
<font face="微软雅黑 light" size="4">BRDF的高光（Specular）</font>

<p>//TODO</p>
<font face="微软雅黑 light" size="5">Cook-Torrance 模型</font>

<font face="微软雅黑 light" size="4">微观表面</font>

<p>BRDF认为表面是没有绝对平滑的，必然有一定程度上的粗糙度，从微观层面来讲这个表面是由一个一个的微平面构成的，这些微平面的法线各异，我们称这种平面叫做<font color="#6495ED">微观表面（microfacets）</font>。由于表面存在粗糙度，微观平面做不到宏观表面那样入射光照完全和法线对称的角度发生反射，微观平面上反射出去的光比较杂乱无规则。如图[6]：</p>
<p><img src="/images/pbr_learning/microfacet.png" alt=""></p>
<p><center>图[6] 左图是微观表面，右图是宏观表面</center><br>因为微观表面的凹凸不平，并不是所有反射出去的光能够进入视野，如下图[7]（暂不考虑二次反射）:</p>
<p><img src="/images/pbr_learning/microfacet_2.png" alt=""></p>
<p><center>图[7]. 左图光照入射方向和视角方向比较接近，微表面的法线也是接近于视角方向的，结果是光照在微平面发射出来的光可以覆盖视角，所以从视角方向看到这部分表面是有光的。右图的情况正好相反导致从视角方向看不到表面的光照的。</center><br>BRDF对于微观表面的处理是在计算的时候加入一个<font color="#6495ED">粗糙度（roughness）</font>的参数。表面的粗糙度越高，表示该表面凹凸不平的越严重，也就是微表面的法线越杂乱，那么表面反射出去的光照方向也就越不规则，实际表现出来就是整个表面看起来光照更加分散，而且光照的强度偏弱。表面的粗糙度越低，表示该表面越光滑，那么表面发射出去的关照方向更加接近一致。实际表现出来就是整个表面的光在正对着入射方向处的最明亮也比较集中，然后向四周慢慢扩散光的强度也随之慢慢降低。如下图[8]：</p>
<p><img src="/images/pbr_learning/roughness.png" alt=""></p>
<p><center>图[8]. 粗糙度由0.1到1.0的变化表现</center><br>//TODO</p>
<hr>
<p>参考：</p>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Physically_based_rendering" target="_blank" rel="external">Wiki Physically based rendering</a></li>
<li><a href="https://3dcoat.com/pbr/" target="_blank" rel="external">3dcoat pbr</a></li>
<li><a href="https://google.github.io/filament/Filament.html#endnote-ibldiffuse1" target="_blank" rel="external">Google filament</a></li>
<li><a href="https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/mathematics-of-shading?url=mathematics-physics-for-computer-graphics/mathematics-of-shading" target="_blank" rel="external">scratchapixle mathematics of shading</a></li>
<li><a href="http://www.codinglabs.net/article_physically_based_rendering_cook_torrance.aspx" target="_blank" rel="external">article_physically_based_rendering_cook_torrance</a></li>
<li><a href="http://www.codinglabs.net/article_physically_based_rendering.aspx" target="_blank" rel="external">article_physically_based_rendering</a></li>
<li><a href="https://learnopengl-cn.github.io/07 PBR/01 Theory/#brdf" target="_blank" rel="external">learnopengl</a> </li>
<li><a href="https://en.wikipedia.org/wiki/Bidirectional_reflectance_distribution_function" target="_blank" rel="external"> Bidirectional_reflectance_distribution_function</a></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yiliangduan.github.com/2019/09/03/graphics/grass_effect/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yiliangduan@gmail.com"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一点心得"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/09/03/graphics/grass_effect/" class="post-title-link" itemprop="url">Unity 草地效果</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-09-03 21:26:10" itemprop="dateCreated datePublished" datetime="2019-09-03T21:26:10+08:00">2019-09-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-09-17 16:06:43" itemprop="dateModified" datetime="2019-09-17T16:06:43+08:00">2019-09-17</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>参考: <a href="https://developer.nvidia.com/gpugems/GPUGems3/gpugems3_ch16.html" target="_blank" rel="external">GPUGems3 Chapter16</a> 。</p>
<p>如果不想看英文版本的话，我阅读的时候根据自己的理解翻译下来，放在<a href="https://github.com/yiliangduan/grass_effect_lab/blob/master/gpu_gems3_ch16.pdf" target="_blank" rel="external">这里</a>，需要的可以参考。</p>
</blockquote>
<p>首先看效果（文件比较大，需要加载一会）:</p>
<p><img src="/images/graphics/grass/grass2.gif" alt="">
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/09/03/graphics/grass_effect/" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yiliangduan.github.com/2019/06/05/graphics/sea_water/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yiliangduan@gmail.com"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一点心得"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/05/graphics/sea_water/" class="post-title-link" itemprop="url">Unity 海水效果</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-05 21:26:10" itemprop="dateCreated datePublished" datetime="2019-06-05T21:26:10+08:00">2019-06-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-09-17 16:12:24" itemprop="dateModified" datetime="2019-09-17T16:12:24+08:00">2019-09-17</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>Unity 2018.3.5.f1</p>
</blockquote>
<p>越来越多的游戏中加入了类似海水的效果，效果挺不错的。这里自己也实现一个，就当做学习了。首先看实现的效果:</p>
<p><img src="/images/sea_water/1.png" alt=""></p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/05/graphics/sea_water/" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-tags" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yiliangduan.github.com/2019/04/22/graphics/mesh_optimizer/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yiliangduan@gmail.com"/>
      <meta itemprop="description" content=""/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一点心得"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/22/graphics/mesh_optimizer/" class="post-title-link" itemprop="url">Unity Mesh合并工具</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-22 20:26:10" itemprop="dateCreated datePublished" datetime="2019-04-22T20:26:10+08:00">2019-04-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-10-14 20:25:33" itemprop="dateModified" datetime="2019-10-14T20:25:33+08:00">2019-10-14</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>Unity  2018.3.5f1</p>
</blockquote>
<p>项目中经常存在很多Material只是贴图不一样的情况，不同的Material是需要单独一个DrawCall来提交数据渲染这个对象的，比如下面场景中五个Cube对象，每个Cube对象使用了一个单独的Material，其中各自的Material只有贴图不一样。因为每个Cube使用了独立的Material，渲染花费了五个DrawCall：</p>
<p><img src="/images/unity_mesh_tool/4.png" alt=""></p>
<p>如果我们把这些贴图合并到一张大的贴图中去（参考<a href="https://www.duanyiliang.com/2018/12/06/graphics/texture_pack_tool/" target="_blank" rel="external">Unity贴图合并工具</a>），然后让那些仅仅是贴图不一样的Material都使用这个合并后的大贴图。针对每个模型修改自己的UV，让Mesh的UV匹配到合并后的大贴图。这样这些模型就可以使用相同的Material了，Unity对使用相同的Material渲染的Mesh会进行<a href="https://docs.unity3d.com/Manual/DrawCallBatching.html" target="_blank" rel="external">动态合批（dynamic batching）</a>。这样游戏运行时这五个Cube只需要一个DrawCall消耗了。进一步思考，dynamic batching可以在运行时刻开辟一块内存把这些分散的Mesh合并到一个新的Mesh中去，我们干脆直接在资源层面将这些Mesh合并，这样还节省运行时刻的内存。这办法可行，下面介绍下一个简单的Mesh合并工具的实现过程。</p>
<p>需要合并Mesh我们需要先了解其数据结构，一个Mesh文件基本组成部分：</p>
<ul>
<li>顶点（vertex）：表示位置的坐标</li>
<li>面（triangles）：顶点连接起来形成的面</li>
<li>UV ：贴图的坐标</li>
<li>颜色（color）：模型的附带颜色</li>
<li>法线（normal）：每个面的垂直线</li>
</ul>
<p>两个独立的Mesh文件，我们只需要把它们这些信息合并就可以得到一个新的Mesh。这个新的Mesh包含了两者的信息。第一步获取这些信息:</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/04/22/graphics/mesh_optimizer/" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yiliangduan@gmail.com</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  



  




  

  

  
  

  
  
    
      
    
      
        
      
    
      
    
      
    
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

  

  

  

  

  

  

  

</body>
</html>
